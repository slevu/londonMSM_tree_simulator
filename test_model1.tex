\documentclass{article}\usepackage[]{graphicx}\usepackage[]{color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\title{Test model1.R plus source attribution - 21 June 2016}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}





\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{require}\hlstd{(phydynR)}
\end{alltt}


{\ttfamily\noindent\color{warningcolor}{Warning: package 'ape' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'expm' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'phytools' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'maps' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'phangorn' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'ggplot2' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'BH' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'Rcpp' was built under R version 3.3.2}}

{\ttfamily\noindent\color{warningcolor}{Warning: package 'RcppArmadillo' was built under R version 3.3.2}}\begin{alltt}
\hlkwd{source}\hlstd{(}\hlstr{'model1.R'}\hlstd{)}

\hlstd{MH} \hlkwb{<-} \hlnum{20}
\hlstd{PID} \hlkwb{<-} \hlkwd{Sys.getpid}\hlstd{()}

\hlcom{# counterfactuals sim'ed separately, eg: }
\hlcom{#~ nh_wtransm <- c( }
\hlcom{#~ 	nh1 = 1}
\hlcom{#~ 	,nh2 = 1}
\hlcom{#~ 	,nh3 = 1}
\hlcom{#~ 	,nh4 = 1}
\hlcom{#~ 	,nh5 = 1}
\hlcom{#~ )}

\hlcom{#~ o <- ode(y=y0, times=times_day, func=dydt, parms=list()  , method = 'adams')}
\hlstd{o} \hlkwb{<-} \hlkwd{ode}\hlstd{(}\hlkwc{y}\hlstd{=y0,} \hlkwc{times}\hlstd{=times_day,} \hlkwc{func}\hlstd{=dydt,} \hlkwc{parms}\hlstd{=}\hlkwd{list}\hlstd{()  ,} \hlkwc{method} \hlstd{=} \hlstr{'rk4'}\hlstd{)}
\hlstd{tfgy} \hlkwb{<-} \hlkwd{.tfgy}\hlstd{( o )}

\hlcom{#############################}
\hlcom{#~ incidence and prevalence }
\hlstd{yfin} \hlkwb{<-} \hlstd{tfgy[[}\hlnum{4}\hlstd{]][[}\hlkwd{length}\hlstd{(times_day)]]}
\hlstd{ffin} \hlkwb{<-} \hlstd{tfgy[[}\hlnum{2}\hlstd{]][[}\hlkwd{length}\hlstd{(times_day)]]}
\hlstd{newinf} \hlkwb{<-} \hlkwd{sum}\hlstd{(ffin[}\hlnum{1}\hlopt{:}\hlnum{120}\hlstd{,} \hlnum{1}\hlopt{:}\hlnum{120}\hlstd{] )} \hlopt{*} \hlnum{365}
\hlstd{plwhiv} \hlkwb{<-} \hlkwd{sum}\hlstd{( yfin[}\hlopt{-}\hlkwd{length}\hlstd{(yfin)] )}

\hlcom{#~  sample time and states}
\hlstd{sampleTimes} \hlkwb{<-} \hlkwd{scan}\hlstd{(} \hlkwc{file} \hlstd{=} \hlstr{'sampleTimes'} \hlstd{)}
\hlstd{ss}  \hlkwb{<-} \hlkwd{matrix}\hlstd{(} \hlkwd{scan}\hlstd{(} \hlkwc{file} \hlstd{=} \hlstr{'sampleStates'} \hlstd{) ,} \hlkwc{byrow}\hlstd{=}\hlnum{TRUE}\hlstd{,} \hlkwc{ncol} \hlstd{= m)}
\hlkwd{colnames}\hlstd{(ss)} \hlkwb{<-} \hlstd{DEMES}
\hlcom{# regularise}
\hlstd{ss} \hlkwb{<-} \hlstd{ss} \hlopt{+} \hlnum{1e-4}
\hlstd{ss} \hlkwb{=} \hlstd{sampleStates} \hlkwb{<-} \hlstd{ss} \hlopt{/} \hlkwd{rowSums}\hlstd{(ss)}

\hlcom{# modify sample times so max corredsponds to 2013 }
\hlstd{sampleTimes} \hlkwb{<-} \hlstd{sampleTimes} \hlopt{+} \hlstd{(}\hlkwd{years2days}\hlstd{(}\hlnum{2013}\hlstd{)} \hlopt{-} \hlkwd{max}\hlstd{(sampleTimes) )}

\hlcom{# test by downsampling}
\hlkwa{if} \hlstd{(F)}
\hlstd{\{}
\hlstd{n} \hlkwb{<-} \hlkwd{length}\hlstd{( sampleTimes )}
\hlstd{keep} \hlkwb{<-} \hlkwd{sample.int}\hlstd{( n,} \hlkwc{size} \hlstd{=} \hlnum{2e3}\hlstd{,} \hlkwc{replace}\hlstd{=F)}
\hlstd{sampleTimes} \hlkwb{<-} \hlstd{sampleTimes[keep]}
\hlstd{sampleStates} \hlkwb{<-} \hlstd{sampleStates[keep, ]}
\hlstd{\}}


\hlcom{## sim tree}

\hlkwd{print}\hlstd{(}\hlstr{'sim tree'}\hlstd{)}
\end{alltt}
\begin{verbatim}
[1] "sim tree"
\end{verbatim}
\begin{alltt}
\hlkwd{print}\hlstd{(}\hlkwd{date}\hlstd{())}
\end{alltt}
\begin{verbatim}
[1] "Wed Jun 21 18:48:10 2017"
\end{verbatim}
\begin{alltt}
\hlstd{st.tree} \hlkwb{<-} \hlkwd{system.time}\hlstd{( \{}
\hlcom{#~ 	daytree <- sim.co.tree.fgy(tfgy,  sampleTimes, sampleStates)}
        \hlstd{daytree} \hlkwb{<-} \hlstd{rcolgem}\hlopt{::}\hlkwd{sim.co.tree.fgy}\hlstd{(tfgy,  sampleTimes, sampleStates)}
\hlstd{\})}
\end{alltt}


{\ttfamily\noindent\color{warningcolor}{Warning in rcolgem::sim.co.tree.fgy(tfgy, sampleTimes, sampleStates): Estimated number of extant lineages at earliest time on time axis is 20.3646096708416, and sampled lineages are not likely to have a single common ancestor. Root of returned tree will have daughter clades corresponding to simulated trees. }}\begin{alltt}
\hlkwd{print}\hlstd{(}\hlkwd{date}\hlstd{())}
\end{alltt}
\begin{verbatim}
[1] "Wed Jun 21 18:50:18 2017"
\end{verbatim}
\begin{alltt}
\hlcom{# rescale tree }
\hlstd{tree} \hlkwb{<-} \hlstd{daytree}
\hlstd{sampleTimes} \hlkwb{<-} \hlkwd{days2years}\hlstd{( tree}\hlopt{$}\hlstd{sampleTimes )}
\hlstd{tree}\hlopt{$}\hlstd{edge.length} \hlkwb{<-} \hlstd{tree}\hlopt{$}\hlstd{edge.length} \hlopt{/} \hlnum{365}
\hlstd{bdt} \hlkwb{<-} \hlkwd{DatedTree}\hlstd{(  tree, sampleTimes, tree}\hlopt{$}\hlstd{sampleStates,} \hlkwc{tol} \hlstd{=} \hlnum{Inf}\hlstd{)}

\hlstd{D} \hlkwb{<-}  \hlkwd{cophenetic.phylo}\hlstd{( bdt )}
\hlkwd{cat}\hlstd{(} \hlstr{'mean genetic divergence if rate = .0015\textbackslash{}n'} \hlstd{)}
\end{alltt}
\begin{verbatim}
mean genetic divergence if rate = .0015
\end{verbatim}
\begin{alltt}
\hlkwd{print}\hlstd{(} \hlkwd{mean}\hlstd{(D )} \hlopt{*} \hlnum{.0015} \hlstd{)}
\end{alltt}
\begin{verbatim}
[1] 0.1489217
\end{verbatim}
\begin{alltt}
\hlstd{n}\hlkwb{<-} \hlstd{bdt}\hlopt{$}\hlstd{n}

\hlstd{treeSampleStates} \hlkwb{<-} \hlstd{tree}\hlopt{$}\hlstd{sampleStates}
\hlstd{cd4s} \hlkwb{<-} \hlkwd{setNames}\hlstd{(} \hlkwd{sapply}\hlstd{(} \hlnum{1}\hlopt{:}\hlkwd{nrow}\hlstd{(treeSampleStates),} \hlkwa{function}\hlstd{(}\hlkwc{k}\hlstd{)\{}
        \hlstd{deme} \hlkwb{<-} \hlstd{DEMES[} \hlkwd{which.max}\hlstd{(treeSampleStates[k,] )  ]}
        \hlstd{stage} \hlkwb{<-} \hlkwd{strsplit}\hlstd{( deme,} \hlstr{'.'} \hlstd{,} \hlkwc{fixed}\hlstd{=T)[[}\hlnum{1}\hlstd{]][}\hlnum{1}\hlstd{]}
        \hlstd{stage} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(} \hlkwd{tail}\hlstd{(} \hlkwd{strsplit}\hlstd{(stage,} \hlstr{''}\hlstd{)[[}\hlnum{1}\hlstd{]],} \hlnum{1} \hlstd{) )}
        \hlkwa{if} \hlstd{(stage}\hlopt{==}\hlnum{1}\hlstd{)} \hlkwd{return}\hlstd{(}\hlnum{1e3}\hlstd{)}
        \hlkwa{if} \hlstd{(stage}\hlopt{==}\hlnum{2}\hlstd{)} \hlkwd{return}\hlstd{(}\hlnum{750}\hlstd{)}
        \hlkwa{if} \hlstd{(stage}\hlopt{==}\hlnum{3}\hlstd{)} \hlkwd{return}\hlstd{(}\hlnum{400}\hlstd{)}
        \hlkwa{if} \hlstd{(stage}\hlopt{==}\hlnum{4}\hlstd{)} \hlkwd{return}\hlstd{(}\hlnum{300}\hlstd{)}
        \hlkwa{if} \hlstd{(stage}\hlopt{==}\hlnum{5}\hlstd{)} \hlkwd{return}\hlstd{(}\hlnum{100}\hlstd{)}
\hlstd{\}), tree}\hlopt{$}\hlstd{tip.label)}
\hlstd{ehis} \hlkwb{<-}  \hlkwd{setNames}\hlstd{(} \hlkwd{sapply}\hlstd{(} \hlnum{1}\hlopt{:}\hlkwd{nrow}\hlstd{( treeSampleStates),} \hlkwa{function}\hlstd{(}\hlkwc{k}\hlstd{)\{}
        \hlstd{deme} \hlkwb{<-} \hlstd{DEMES[} \hlkwd{which.max}\hlstd{(treeSampleStates[k,] )  ]}
        \hlstd{stage} \hlkwb{<-} \hlkwd{strsplit}\hlstd{( deme,} \hlstr{'.'} \hlstd{,} \hlkwc{fixed}\hlstd{=T)[[}\hlnum{1}\hlstd{]][}\hlnum{1}\hlstd{]}
        \hlstd{stage} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(} \hlkwd{tail}\hlstd{(} \hlkwd{strsplit}\hlstd{(stage,} \hlstr{''}\hlstd{)[[}\hlnum{1}\hlstd{]],} \hlnum{1} \hlstd{) )}
        \hlkwd{ifelse}\hlstd{( stage}\hlopt{==}\hlnum{1}\hlstd{,} \hlnum{TRUE}\hlstd{,} \hlnum{FALSE}\hlstd{)}
\hlstd{\}), tree}\hlopt{$}\hlstd{tip.label)}
\hlstd{sampleDemes} \hlkwb{<-} \hlkwd{setNames}\hlstd{(} \hlkwd{sapply}\hlstd{(} \hlnum{1}\hlopt{:}\hlstd{n,} \hlkwa{function}\hlstd{(}\hlkwc{u}\hlstd{) DEMES[}\hlkwd{which.max}\hlstd{( treeSampleStates[u,])] ), tree}\hlopt{$}\hlstd{tip.label )}

\hlkwd{system.time}\hlstd{(}
  \hlstd{W} \hlkwb{<-} \hlkwd{phylo.source.attribution.hiv.msm}\hlstd{( bdt}
                                         \hlstd{, bdt}\hlopt{$}\hlstd{sampleTimes} \hlcom{# must use years}
                                         \hlstd{,} \hlkwc{cd4s} \hlstd{= cd4s[bdt}\hlopt{$}\hlstd{tip.label]} \hlcom{# named numeric vector, cd4 at time of sampling }
                                         \hlstd{,} \hlkwc{ehi} \hlstd{= ehis[bdt}\hlopt{$}\hlstd{tip.label]} \hlcom{# named logical vector, may be NA, TRUE if patient sampled with early HIV infection (6 mos )}
                                         \hlstd{,} \hlkwc{numberPeopleLivingWithHIV}  \hlstd{= plwhiv}\hlcom{# scalar}
                                         \hlstd{,} \hlkwc{numberNewInfectionsPerYear} \hlstd{= newinf} \hlcom{# scalar }
                                         \hlstd{,} \hlkwc{maxHeight} \hlstd{= MH}
                                         \hlcom{#, res = 1e3}
                                         \hlcom{#, treeErrorTol = Inf}
                                         \hlcom{#, minEdgeLength = 1/52}
  \hlstd{)}
\hlstd{)}
\end{alltt}
\begin{verbatim}
[1] "NOTE : sample times must be in units of years"
[1] "start source attrib"
[1] "Wed Jun 21 18:51:40 2017"
\end{verbatim}


{\ttfamily\noindent\bfseries\color{errorcolor}{Error in sourceAttribMultiDemeCpp2(heights, Fs[fgyi], Gs[fgyi], Ys[fgyi], : c++ exception (unknown reason)}}\begin{verbatim}
Timing stopped at: 19.304 8.026 27.421 
\end{verbatim}
\end{kframe}
\end{knitrout}


\end{document}
